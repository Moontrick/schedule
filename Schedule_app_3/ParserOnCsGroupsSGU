using System;
using HtmlAgilityPack;
using System.Net.Http;
using System.Collections.Generic;
using System.Linq;
using System.Security.Claims;
using System.Reflection.Metadata;

namespace Csharpconsole
{
    class Program
    {

        static void Parsing_Start()
        {
            var result = Parsing(url: "https://www.sgu.ru/schedule/knt");
        }

        public static string Parsing(string url)
        {
            try
            {
                using (HttpClientHandler hdl = new HttpClientHandler { AllowAutoRedirect = false, AutomaticDecompression = System.Net.DecompressionMethods.Deflate | System.Net.DecompressionMethods.GZip | System.Net.DecompressionMethods.None })
                {
                    using (var client = new HttpClient(hdl))
                    {
                        using (HttpResponseMessage resp = client.GetAsync(url).Result)
                        {
                            if (resp.IsSuccessStatusCode)
                            {
                                var html = resp.Content.ReadAsStringAsync().Result;
                                if (!string.IsNullOrEmpty(html))
                                {
                                    HtmlDocument doc = new HtmlDocument();
                                    doc.LoadHtml(html);
                                    string name_par = "";
                                    string porgoup = "";
                                    string stri = "//*[@id=\"schedule_page\"]/fieldset[1]/div"; //заранее сохраняем строку индекса
                                    int l = 1;
                                    while (doc.DocumentNode.SelectSingleNode(stri + "/fieldset[" + System.Convert.ToString(l) + "]") != null) // пока есть что парсить
                                    {
                                        var table1 = doc.DocumentNode.SelectSingleNode(stri + "/fieldset[" + System.Convert.ToString(l) + "]");//чисто по приколу
                                         var table5 = doc.DocumentNode.SelectSingleNode(stri + "/fieldset[" + System.Convert.ToString(l) + "]/legend/span");//тип группы 
                                        porgoup = table5.InnerText;
                                        Console.WriteLine(porgoup);
                                        int h = 1;
                                        while (doc.DocumentNode.SelectSingleNode(stri + "/fieldset[" + System.Convert.ToString(l) + "]/div/fieldset[" + System.Convert.ToString(h) + "]/div/a[1]") != null)//столбец
                                        {
                                            int k = 1;
                                            var table = doc.DocumentNode.SelectSingleNode(stri + "/fieldset[" + System.Convert.ToString(l) + "]/div/fieldset[" + System.Convert.ToString(h) + "]/div/a[1]");//строка
                                            while (table != null)
                                            {
                                                table = doc.DocumentNode.SelectSingleNode(stri + "/fieldset[" + System.Convert.ToString(l) + "]/div/fieldset[" + System.Convert.ToString(h) + "]/div/a[" + System.Convert.ToString(k) + "]");
                                                if (table == null)
                                                {
                                                    break;
                                                }
                                                else
                                                {
                                                    name_par = table.InnerText;
                                                    Console.WriteLine(name_par);
                                                    k++;
                                                }
                                            }
                                            h++;
                                        }
                                        l++;
                                    }
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex) { Console.WriteLine(ex.Message); }
            return null;
        }

        static void Main()
        {
            Parsing_Start();
        }
    }
}
